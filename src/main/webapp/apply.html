<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>申请管理</title>
    <link href="css/semantic.min.css" rel="stylesheet">
    <link href="css/tagcloud.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/jquery-2.0.3.min.js"></script>
    <script src="js/semantic.min.js"></script>
    <script src="js/siderbar.js"></script>
    <script src="js/tagcloud.min.js"></script>
    <script src="js/jquery.ui.widget.js" type="text/javascript"></script>
    <script src="js/jquery.iframe-transport.js" type="text/javascript"></script>
    <script src="js/common.js"></script>
    <script src="js/echarts.js"></script>
    <script src="js/plugins/laydate/laydate.js"></script>


</head>

<body class="pushable">
<div class="ui fixed borderless inverted menu">
    <div class="ui container">
        <a href="/" class="header item">

        </a>
        <a href="index.html" class="item"><i class="home icon"></i> 首页</a>
        <a href="apply.html" class="item"><i class="list layout icon"></i> 申请管理</a>
        <a href="authorize.html" class="item"><i class="list layout icon"></i> 授权管理</a>
        <a href="effective.html" class="item"><i class="list layout icon"></i> 有效管理</a>
       <!-- <a href="region_manager.html" class="item"><i class="list layout icon"></i>分词库管理</a>-->
        <div class="right item">
            <div class="ui dropdown">
                <a class="acctInfo"></a>
                <!--<div class="text acctInfo"></div>-->
                <i class="dropdown icon"></i>
                <div class="menu">
                    <div class="item" data-value="modify-password">修改密码</div>
                    <div class="item" data-value="quit">退出</div>
                </div>

            </div>
        </div>
    </div>
</div>
<div class="pusher">
    <div class="ui large secondary borderless pointing menu"></div>

    <div class="nav-divider"></div>

    <div class="ui container" >
        <div class="ui stackable grid">
            <div class="eleven wide column">
                <div class="ui dimmer">
                    <div class="ui indeterminate text loader">正在处理中</div>
                </div>

                <div class="ui large tabular menu red">
                    <a class="item active item-type" data-value="0">申请未校验管理</a>
                    <a class="item item-type" data-value="1">申请已校验管理 </a>
                </div>
                <div class="ui message floating  hidden transition">
                    <i class="close icon"></i>
                    <div class="header">消息 </div>
                    <p class="myMessage"></p>
                </div>
                <!-- <h3 class="ui horizontal divider header red "> </h3>-->
                <div class="ui segment">
                    <div class="ui two column stackable grid">
                        <div class="column">
                            <button class="ui red basic button add-excel-btn">导入</button>
                            <button class="ui orange basic button resolve-all-address-btn" style="text-align:right;">全量解析</button>
                        </div>
                        <div class="column">
                            <div style="text-align:right;">
                                <div class="ui action left icon input">
                                    <i class="search icon"></i>
                                    <input type="text" id="searchTime" placeholder="请选择月份">
                                    <div class="ui teal button export-btn">导出</div>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
                <div class="ui segment">
                    <table class="ui celled table" >
                        <thead>
                        <th >申请号</th>
                        <th >申请日</th>
                        <th >申请人地址</th>
                        <th >已标记地址化区</th>
                        <th >已标记四区一岛</th>
                        <th >地址化区</th>
                        <th >四区一岛</th>
                        <th >分词结果</th>
                        </thead>

                        <tbody>
                        </tbody>
                    </table>
                    <div>
                        <tr>
                            <th colspan="5">
                                <div class="ui label">
                                    当前显示第
                                    <div class="ui label start">
                                    </div>
                                    到第
                                    <div class="ui label end">
                                    </div>
                                    条记录，总共
                                    <div class="ui label totalNumber">
                                    </div>
                                    条记录，每页显示
                                    <div class="ui label pageNumber">
                                    </div>
                                    条记录
                                </div>

                            </th>
                            <th colspan="3">
                            <td> <button class="ui left labeled icon previous-btn button"><i class="left arrow icon"></i> 上一页 </button></td>
                            <td> <button class="ui right labeled icon next-btn button"><i class="right arrow icon"></i> 下一页 </button></td>
                            </th>
                        </tr>
                    </div>
                </div>
            </div>
            <div class="five wide column">
                <div class="row relative">
                    <h2 class="ui dividing header red">
                        <i class="pie chart icon red"></i>
                        报表设置
                    </h2>
                </div>
                <div class="ui segment">
                    <div class="ui form">
                        <div class="inline fields">
                            <label>请选择类别：</label>
                            <div class="field">
                                <div class="ui radio checkbox">
                                    <input type="radio" class="region-radio" name="region-radio" value="0" checked="checked">
                                    <label>行政区</label>
                                </div>
                            </div>
                            <div class="field">
                                <div class="ui radio checkbox">
                                    <input type="radio" class="region-radio" name="region-radio" value="1">
                                    <label>功能区</label>
                                </div>
                            </div>

                        </div>
                        <div class="inline fields">
                            <label>请选择月份：</label>
                            <div class="field">
                                <input type="text" id="time" style="height:100%;width:100%;">
                            </div>

                        </div>
                    </div>
                </div>
                <h2 class="ui dividing header red">
                    <i class="pie chart icon red"></i>
                    报表显示
                </h2>
                <div class="ui segment" style="height: 560px;">
                    <div id="main" style="width: 100%;height: 100%;"></div>
                </div>
            </div>
        </div>

    </div>
    <!-- footer -->
    <div class="ui inverted vertical segment" style="height: 50px;text-align:center;">
        <div style="text-align: center;color:white;"> Copyright © 2017 宁波科技信息研究院版权所有</div>
    </div>



    <!-- 文件上传模态框 -->
    <div class="ui modal file-upload-modal">
        <div class="header">
            文件上传
        </div>
        <div class="content">
            <div class="ui center aligned text container">
                <div class="ui mini action left icon fluid input">
                    <form id="upload" enctype="multipart/form-data" method="post">
                        <input type="file" name="file" id="file"/>
                        <input type="text" name="type" value="0" hidden>
                        <input type="text" name="state" value="0" hidden>
                    </form>
                </div>
            </div>
        </div>
        <div class="actions">
            <button class="ui negative button cancel">取消</button>
            <button class="ui positive button commit">提交</button>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="ui modal small modify-modal">
        <div class="header">
            修改密码
        </div>
        <div class="content">

            <div class="ui center aligned text container" style="width: 90%;">
                <div class="ui message hidden modify-password-message">
                    <ul class='list'></ul>
                </div>

                <form class="ui form" >
                    <div class="field">
                        <div class="ui left icon input">
                            <i class="lock icon"></i>
                            <input type="password" id="password"  name="password" placeholder="请输入新密码" >
                        </div>
                    </div>
                    <div class="field">
                        <div class="ui left icon input">
                            <i class="lock icon"></i>
                            <input type="password" id="confirmPassword" name="confirmPassword" placeholder="请输入确认密码">
                        </div>
                    </div>
                    <div class="ui error message"></div>

                </form>
                <button class="ui negative button cancel-btn">关闭</button>
                <button class="ui positive button modify-btn">修改</button>
            </div>
        </div>
    </div>

    <!-- 退出模态框 -->
    <div class="ui modal exit-modal">
        <div class="header">
            退出
        </div>
        <div class="content">
            <div class="ui center aligned text container">
                <div class="ui mini action left icon fluid input">
                    <p>您是否确定退出该系统，确定请按退出，否则请按取消</p>
                </div>
            </div>
        </div>
        <div class="actions">
            <button class="ui negative button cancel-btn">取消</button>
            <button class="ui positive button exit-btn">退出</button>
        </div>
    </div>

</div>
</body>

<script>
    var page = 1;//记录当前处于第几页
    var index = 0;
    var state = 0;
    var type = 0;

    // 分页参数
    var start = 0;
    var end = 0;
    var totalNumber = 0;
    var pageNumber =0;
    var totalPage = 0;

    var moduleCode = '01';
    var functionOrRegion = 0;
    var time;
    var searchTime;

    var myChart ;

    $(function () {
        function initFun() {
        };


        findModuleParameter(moduleCode, initFun);
        //执行一个laydate实例
        laydate.render({
            elem: '#time', //指定元素
            type: 'month',
            value: new Date(),
            done: function (value, date) {
                time = value;
                document.getElementById('time').value = value;
                loadChart();
            }
        });

        laydate.render({
            elem: '#searchTime', //指定元素
            type: 'month',
            value: new Date(),
            done: function (value, date) {
                searchTime = value;
                document.getElementById('searchTime').value = value;
            }
        });

        searchTime = document.getElementById('searchTime').value;
        time = document.getElementById('time').value;
        // searchTime.value = document.getElementById('time').value;

     //   $('.previous-btn').hide();
      //  $('.next-btn').hide();

        // findAddressList(page);
        findAddressPage(page);

        /* $('form').form({
            on: 'blur',
            fields: {
                password: {
                    identifier: 'password',
                    rules: [{
                        type: 'empty',
                        prompt: '请输入新密码'
                    }]
                },
                confirmPassword: {
                    identifier: 'confirmPassword',
                    rules: [{
                        type: 'empty',
                        prompt: '请输入确认密码'
                    },{
                        type   : 'match[dog]',
                        prompt : '{name} is set to "{value}" that is totally wrong. It should be {ruleValue}'
                    }]
                }
            }
        });*/


        myChart = echarts.init(document.getElementById('main'));

        loadChart();
        $('.ui.dropdown').dropdown({
            onChange: function (value, text) {
                if (value == "modify-password") {
                    $('.ui.modify-modal').modal('show');
                } else if (value == "quit") {
                    $('.ui.exit-modal').modal('show');
                }
            }
        })

        $('.region-radio').change(function () {
            var radio = document.getElementsByName("region-radio");
            for (i = 0; i < radio.length; i++) {
                if (radio[i].checked) {
                    functionOrRegion = radio[i].value;
                }
            }
            loadChart();
        })

        $('h3').text("请选择要导入的文件！ ");

        $('.add-excel-btn').click(function () {
            $('.file-upload-modal').modal('show');
        });

        $('.cancel').click(function () {
            //  $('.ui.modal').modal('hide');
        });

        $('.commit').click(function () {
            $('.ui.dimmer').addClass('active');
            var form = document.getElementById('upload'),
                formData = new FormData(form);
            $.ajax({
                url: "address/importExcel",
                type: "post",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res.head) {
                        $('.ui.dimmer').removeClass('active');
                        $('.ui.dimmer').removeClass('active');
                        $('.ui.message').removeClass('hidden');
                        $('.ui.message').addClass('positive');
                        $('.myMessage').text(res.body);
                        findAddressPage(page);

                    } else {
                        $('.ui.dimmer').removeClass('active');
                        $('.ui.message').removeClass('hidden');
                        $('.ui.message').addClass('negative');
                        $('.myMessage').text(res.body);
                        // findAddressList(page);
                        findAddressPage(page);
                    }
                },
                error: function (err) {
                    alert("网络连接失败,稍后重试", err);
                }
            })
        });

        $('.resolve-all-address-btn').click(function () {
            if (parseInt(totalNumber) == 0) {
                alert('请先导入要解析的文件！');
            } else {
                $('.ui.dimmer').addClass('active');
                $.ajax({
                    type: "post",
                    url: 'address/parseAllAddress',
                    traditional: true,
                    data: {
                        type: type
                    },
                    success: function (data) {
                        if (data.head) {
                            $('.ui.dimmer').removeClass('active');
                            $('.ui.message').removeClass('hidden');
                            $('.ui.message').addClass('positive');
                            $('.myMessage').text(data.body);
                            page = 1;
                            //    findAddressList(page);
                            findAddressPage(page);
                            loadChart();
                        } else {

                            $('.ui.dimmer').removeClass('active');
                            $('.ui.message').removeClass('hidden');
                            $('.ui.message').addClass('negative');
                            $('.myMessage').text(data.body);

                            page = 1;
                            //   findAddressList(page);
                            findAddressPage(page);
                        }

                    }
                });
            }

        })

        $('.export-btn').click(function () {
            $.ajax({
                type: "post",
                url: 'address/exportExcel',
                traditional: true,
                data: {
                    type: type,
                    time: searchTime
                },
                success: function (data) {
                    if (data.head) {
                        $('.ui.message').removeClass('hidden');
                        $('.ui.message').addClass('positive');
                        $('.myMessage').text(data.body);
                    } else {
                        $('.ui.message').removeClass('hidden');
                        $('.ui.message').addClass('negative');
                        $('.myMessage').text(data.body);
                    }

                },
                error: function (error) {
                }
            })
        })

        $(document).on('click', '.previous-btn', function () {
            if (page > 1) {
                page--;
                //  findAddressList(page);
                findAddressPage(page);
            } else {
                $('.previous-btn').hide();
                //alert('当前已经是最小页')
            }
        })

        $(document).on('click', '.next-btn', function () {
            if (totalPage > page) {
                page++;
                // alert(page);
                //   findAddressList(page);
                findAddressPage(page);

            } else {
                // alert('当前已经是最大页')
                $('.previous-btn').show();
            }

        })

        $('.exit-btn').click(function () {
            $.getJSON('account/exit', function (data) {
                if (data.head) {
                    window.location.href = './login.html';
                }
            });
        })

        $('.message .close').on('click', function () {
            $(this)
                .closest('.message')
                .transition('fade')
            ;
        })

        $('.cancel-btn').click(function () {
            $('.ui.modify-modal').modal('hide');
        })

        $('.modify-btn').click(function () {
            var password = document.getElementById('password').value;
            var confirmPassword = document.getElementById('confirmPassword').value;
            var message = $('.list').empty();

            if (password == null || password == '') {
                $('.modify-password-message').removeClass('hidden');
                $('.modify-password-message').addClass('negative');
                $("<li></li>").append('新密码不能为空！')
                    .appendTo(message);
            } else {
                if (confirmPassword == null || confirmPassword == '') {
                    $('.modify-password-message').removeClass('hidden');
                    $('.modify-password-message').addClass('negative');
                    $("<li></li>").append('确认密码不能为空！')
                        .appendTo(message);
                } else if (password != confirmPassword) {
                    $('.modify-password-message').removeClass('hidden');
                    $('.modify-password-message').addClass('negative');
                    $("<li></li>").append('新密码和确认密码不相同！')
                        .appendTo(message);
                } else {
                    $.getJSON('account/modifyPass',
                        {
                            password: password
                        },
                        function (data) {
                            if (data.head) {
                                $('.modify-password-message').removeClass('hidden');
                                $('.modify-password-message').addClass('positive');
                                $("<li></li>").append(data.body)
                                    .appendTo(message);
                            } else {
                                $('.modify-password-message').removeClass('hidden');
                                $('.modify-password-message').addClass('negative');
                                $("<li></li>").append(data.body)
                                    .appendTo(message);
                            }
                        });
                }
            }

        })

        /** 切换 未校验、已校验 **/
        $('.item-type').click(function () {
            index = $(this).attr('data-value');
            $(this).parent().find('a').eq(0).attr('class', 'item item-type');
            $(this).parent().find('a').eq(1).attr('class', 'item item-type');
            $(this).attr('class', 'item active item-type');
            if (index == 0) {
                state = 0;
                $('.add-excel-btn').show();
                $('.resolve-all-address-btn').show();
                // $('.add-excel-btn').removeClass('disabled');
                // $('.resolve-all-address-btn').removeClass('disabled');
                $('h3').text("请选择导入的文件！ ");
            } else if (index == 1) {
                state = 1;
                $('.add-excel-btn').hide();
                $('.resolve-all-address-btn').hide();
                // $('.add-excel-btn').addClass('disabled');
                // $('.resolve-all-address-btn').addClass('disabled');
                $('h3').text("解析之后的结果！");

            }

            findAddressPage(page);
            //  findAddressList(1);


        });

    });


    function findAddressList(page) {
        var tbody = $('tbody').empty();
        $.post('address/findAddressListByPage', {
            page: page,
            search: '',
            type:type,
            state:state
        }, function (data) {
            if (typeof data != 'object') {
                data = $.parseJSON(data);
            }
            if(data.head) {
                if(page>1) {
                    $('.previous-btn').show();
                }else{
                    $('.previous-btn').hide();
                }

                if(page<totalPage) {
                    $('.next-btn').show();
                }else{
                    $('.next-btn').hide();
                }

                $.each(data.body, function (index, value) {
                    $('<tr></tr>')
                        .append($("<td></td>").append(value.request_number))
                        .append($("<td></td>").append(value.request_date))
                        .append($("<td></td>").append(value.requester_address))
                        .append($("<td></td>").append(value.region_marked))
                        .append($("<td></td>").append(value.function_region_marked))
                        .append($("<td></td>").append(value.region))
                        .append($("<td></td>").append(value.function_region))
                        .append($("<td></td>").append(value.remark))
                        .appendTo(tbody);
                });
            }else{
                $('.previous-btn').hide();
                $('.next-btn').hide();
            }

        })
    };

    function findAddressPage(page) {
        $.post('address/findAddressPage', {
            page: page,
            search: '',
            type:type,
            state:state
        }, function (data) {
            console.log(data);
            if (typeof data != 'object') {
                data = $.parseJSON(data);
            }

            totalNumber = data.body.count;
            pageNumber = data.body.number;
            totalPage = data.body.totalPage;

            if(totalPage==0) {
                start = 0;
                end = 0;
            }else if(totalPage==1) {
                start = 0;
                end = totalNumber - 1;
            }else{
                start = (data.body.nowPage - 1) * pageNumber;
                if(totalNumber>=data.body.nowPage*pageNumber) {
                    end = data.body.nowPage * pageNumber - 1;
                }else{
                    end = totalNumber - 1;
                }
            }
            $('.start').text(start);
            $('.end').text(end);
            $('.totalNumber').text(totalNumber);
            $('.pageNumber').text(pageNumber);

            findAddressList(page);

        })
    };

    function findModuleParameter(moduleCode, initFun) {
        if (!moduleCode) return;
        $.getJSON('module/findModuleParameter', {moduleCode: moduleCode}, function (data) {
            if(data.head){
                $('a.acctInfo').append(data.body.account);
            }else{
                if ('UNLOGIN' == data.body) {
                    window.location.href = '/mgr/login.html';
                }
            }
            initFun();
        });
    };

    <!-- 与图相关函数 -->
    function loadChart() {
        // 异步加载数据
        $.post('address/getDataPrecision', {
            type: type,
            functionOrRegion:functionOrRegion,
            time:time
        }, function (result) {
            myChart.setOption({
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                },
                legend: {
                    orient: 'vertical',
                    x: 'left',
                    data: ['正确数', '错误数', '其他情况']
                },
                series: [
                    {
                        // name: '正确率',
                        type: 'pie',
                        radius: ['50%', '70%'],
                        avoidLabelOverlap: false,
                        label: {
                            normal: {
                                show: false,
                                position: 'center'
                            },
                            emphasis: {
                                show: true,
                                textStyle: {
                                    fontSize: '30',
                                    fontWeight: 'bold'
                                }
                            }
                        },
                        labelLine: {
                            normal: {
                                show: false
                            }
                        },
                        data: result.body
                    }
                ]
            })
        })
    }
    <!-- 与图相关函数 -->
</script>
</html>